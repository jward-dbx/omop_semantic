version: 1.1

source: conn_sf_cursor_ward_catalog.OMOP.CONDITION_OCCURRENCE

joins:
  - name: person
    source: conn_sf_cursor_ward_catalog.OMOP.PERSON
    "on": source.person_id = person.person_id
  - name: concept
    source: conn_sf_cursor_ward_catalog.OMOP.CONCEPT
    "on": source.condition_concept_id = concept.concept_id
  - name: visit
    source: conn_sf_cursor_ward_catalog.OMOP.VISIT_OCCURRENCE
    "on": source.visit_occurrence_id = visit.visit_occurrence_id
  - name: provider
    source: conn_sf_cursor_ward_catalog.OMOP.PROVIDER
    "on": source.provider_id = provider.provider_id

dimensions:
  - name: Condition Name
    expr: concept.concept_name
  - name: Diagnosis Year
    expr: YEAR(source.condition_start_date)
  - name: Diagnosis Month
    expr: "DATE_TRUNC('MONTH', source.condition_start_date)"
  - name: Condition Category
    expr: CASE WHEN concept.concept_name LIKE '%diabetes%' THEN 'Diabetes' WHEN concept.concept_name
      LIKE '%hypertens%' THEN 'Hypertension' WHEN concept.concept_name LIKE '%pneumonia%'
      THEN 'Respiratory' WHEN concept.concept_name LIKE '%chest pain%' THEN 'Cardiovascular'
      ELSE 'Other' END
  - name: Patient Gender
    expr: CASE person.gender_concept_id WHEN 8507 THEN 'Male' WHEN 8532 THEN 'Female'
      ELSE 'Unknown' END
  - name: Patient Age Group
    expr: CASE WHEN YEAR(source.condition_start_date) - person.year_of_birth < 18
      THEN '0-17' WHEN YEAR(source.condition_start_date) - person.year_of_birth <
      30 THEN '18-29' WHEN YEAR(source.condition_start_date) - person.year_of_birth
      < 45 THEN '30-44' WHEN YEAR(source.condition_start_date) - person.year_of_birth
      < 65 THEN '45-64' ELSE '65+' END
  - name: Visit Type
    expr: CASE visit.visit_concept_id WHEN 9201 THEN 'Inpatient' WHEN 9202 THEN 'Outpatient'
      WHEN 9203 THEN 'Emergency Room' ELSE 'Other' END
  - name: Provider Name
    expr: provider.provider_name

measures:
  - name: Total Diagnoses
    expr: COUNT(source.condition_occurrence_id)
  - name: Unique Patients With Condition
    expr: COUNT(DISTINCT source.person_id)
  - name: Prevalence Rate Per 100 Patients
    expr: COUNT(DISTINCT source.person_id) * 100.0
  - name: Diagnoses Per Patient
    expr: "COUNT(source.condition_occurrence_id) * 1.0 / NULLIF(COUNT(DISTINCT source.person_id),\
      \ 0)"
  - name: Active Conditions
    expr: COUNT(CASE WHEN source.condition_end_date IS NULL OR source.condition_end_date
      >= CURRENT_DATE THEN source.condition_occurrence_id END)
  - name: Resolved Conditions
    expr: COUNT(CASE WHEN source.condition_end_date < CURRENT_DATE THEN source.condition_occurrence_id
      END)
  - name: Diabetes Patients
    expr: COUNT(DISTINCT CASE WHEN concept.concept_name LIKE '%diabetes%' THEN source.person_id
      END)
  - name: Hypertension Patients
    expr: COUNT(DISTINCT CASE WHEN concept.concept_name LIKE '%hypertens%' THEN source.person_id
      END)
