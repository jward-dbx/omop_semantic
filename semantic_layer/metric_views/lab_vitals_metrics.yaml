version: 1.1

source: conn_sf_cursor_ward_catalog.OMOP.MEASUREMENT

joins:
  - name: person
    source: conn_sf_cursor_ward_catalog.OMOP.PERSON
    "on": source.person_id = person.person_id
  - name: concept
    source: conn_sf_cursor_ward_catalog.OMOP.CONCEPT
    "on": source.measurement_concept_id = concept.concept_id
  - name: visit
    source: conn_sf_cursor_ward_catalog.OMOP.VISIT_OCCURRENCE
    "on": source.visit_occurrence_id = visit.visit_occurrence_id
  - name: provider
    source: conn_sf_cursor_ward_catalog.OMOP.PROVIDER
    "on": source.provider_id = provider.provider_id

dimensions:
  - name: Measurement Name
    expr: concept.concept_name
  - name: Measurement Type
    expr: CASE WHEN concept.concept_name LIKE '%blood pressure%' THEN 'Vital Signs'
      WHEN concept.concept_name LIKE '%temperature%' THEN 'Vital Signs' WHEN concept.concept_name
      LIKE '%heart rate%' THEN 'Vital Signs' WHEN concept.concept_name LIKE '%glucose%'
      THEN 'Lab Test' WHEN concept.concept_name LIKE '%hemoglobin%' THEN 'Lab Test'
      ELSE 'Other' END
  - name: Measurement Year
    expr: YEAR(source.measurement_date)
  - name: Measurement Month
    expr: "DATE_TRUNC('MONTH', source.measurement_date)"
  - name: Patient Gender
    expr: CASE person.gender_concept_id WHEN 8507 THEN 'Male' WHEN 8532 THEN 'Female'
      ELSE 'Unknown' END
  - name: Patient Age Group
    expr: CASE WHEN YEAR(source.measurement_date) - person.year_of_birth < 18 THEN
      '0-17' WHEN YEAR(source.measurement_date) - person.year_of_birth < 30 THEN '18-29'
      WHEN YEAR(source.measurement_date) - person.year_of_birth < 45 THEN '30-44'
      WHEN YEAR(source.measurement_date) - person.year_of_birth < 65 THEN '45-64'
      ELSE '65+' END
  - name: Result Range Status
    expr: CASE WHEN source.value_as_number < source.range_low THEN 'Below Normal'
      WHEN source.value_as_number > source.range_high THEN 'Above Normal' WHEN source.value_as_number
      BETWEEN source.range_low AND source.range_high THEN 'Normal' ELSE 'Unknown'
      END
  - name: Visit Type
    expr: CASE visit.visit_concept_id WHEN 9201 THEN 'Inpatient' WHEN 9202 THEN 'Outpatient'
      WHEN 9203 THEN 'Emergency Room' ELSE 'Other' END
  - name: Provider Name
    expr: provider.provider_name

measures:
  - name: Total Measurements
    expr: COUNT(source.measurement_id)
  - name: Unique Patients Tested
    expr: COUNT(DISTINCT source.person_id)
  - name: Tests Per Patient
    expr: "COUNT(source.measurement_id) * 1.0 / NULLIF(COUNT(DISTINCT source.person_id),\
      \ 0)"
  - name: Average Value
    expr: AVG(source.value_as_number)
  - name: Median Value
    expr: PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY source.value_as_number)
  - name: Min Value
    expr: MIN(source.value_as_number)
  - name: Max Value
    expr: MAX(source.value_as_number)
  - name: Abnormal Results Count
    expr: COUNT(CASE WHEN source.value_as_number < source.range_low OR source.value_as_number
      > source.range_high THEN source.measurement_id END)
  - name: Abnormal Result Rate
    expr: "COUNT(CASE WHEN source.value_as_number < source.range_low OR source.value_as_number\
      \ > source.range_high THEN source.measurement_id END) * 100.0 / NULLIF(COUNT(source.measurement_id),\
      \ 0)"
  - name: Patients With Abnormal Results
    expr: COUNT(DISTINCT CASE WHEN source.value_as_number < source.range_low OR source.value_as_number
      > source.range_high THEN source.person_id END)
  - name: Hypertensive Readings Count
    expr: COUNT(CASE WHEN concept.concept_name LIKE '%Systolic%' AND source.value_as_number
      >= 140 THEN source.measurement_id END)
  - name: Elevated Glucose Count
    expr: COUNT(CASE WHEN concept.concept_name LIKE '%Glucose%' AND source.value_as_number
      >= 126 THEN source.measurement_id END)
